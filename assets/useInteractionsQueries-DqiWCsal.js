import{q as E,n as Q,v as L,o as _,p as q,s as A,t as I,r as v,j as e,G as o,w as f,h as R,C as T,b as N,d as O,L as V,A as W,x as G}from"./index-yZ3Mwj4X.js";import{t as S,p as y,u as x,c as h,d as P,A as U,D as z,a as H,b as $,M as J,e as X}from"./useSnackbar-DOuwzC57.js";import{D as Y}from"./DataTable-DdGNm8-b.js";import{f as w,t as Z}from"./date-Co2jqw76.js";import{u as B,C as F}from"./index.esm-BkKeSs8t.js";import{u as tt}from"./useContactsQueries-ByiqcEGY.js";import{F as et,s as nt}from"./FlexGrow-lwngye7Z.js";const at=async t=>{const c=(await E(`SELECT * FROM interactions
     WHERE interaction_id IN (
       SELECT interaction_id FROM interaction_contacts
       WHERE contact_id = :contactId)`,t)).map(i=>({...i,contacts:[]})),u=S(c,"interactionId"),l=await E("SELECT * FROM contacts"),p=S(l,"contactId");return(await E("SELECT * FROM interaction_contacts")).forEach(i=>{const a=u.get(i.interactionId),r=p.get(i.contactId);!a||!r||a.contacts.push(r)}),Array.from(u.values())},rt=async t=>await Q("interactions",y({...t,interactionId:L()},["interactionId","interactionType","interactionDate","notes"])),st=async t=>await _("interactions",y(t,["interactionType","interactionDate","notes"]),y(t,["interactionId"])),it=async t=>await q("interactions",y(t,["interactionId"])),D=async t=>await A("interaction_contacts",t.contacts.map(({contactId:n})=>({interactionId:t.interactionId,contactId:n}))),ot=async t=>{await K(t),await D(t)},K=async t=>{await q("interaction_contacts",y(t,["interactionId","contactId"]))},ct=()=>{const t=I(),{showSnackbar:n}=x();return h({mutationFn:rt,onSuccess:()=>{t.invalidateQueries({queryKey:["interactions"]}),n("Interaktion sparat!")},onError:()=>{n("Ett fel uppstod när interaktionen skulle sparas.","error")}})},ut=()=>{const t=I(),{showSnackbar:n}=x();return h({mutationFn:st,onSuccess:()=>{t.invalidateQueries({queryKey:["interactions"]}),n("Interaktion uppdaterat!")},onError:()=>{n("Ett fel uppstod när interaktionen skulle uppdateras.","error")}})},lt=()=>{const t=I(),{showSnackbar:n}=x();return h({mutationFn:c=>Promise.all([it(c),K(c)]),onSuccess:()=>{t.invalidateQueries({queryKey:["interactions"]}),n("Interaktion borttaget!")},onError:()=>{n("Ett fel uppstod när interaktionen skulle tas bort.","error")}})},dt=()=>{const t=I(),{showSnackbar:n}=x();return h({mutationFn:D,onSuccess:()=>{t.invalidateQueries({queryKey:["interactions"]}),n("Interaktion skapad!")},onError:()=>{n("Ett fel uppstod när interaktionen skulle skapas.","error")}})},pt=()=>{const t=I(),{showSnackbar:n}=x();return h({mutationFn:ot,onSuccess:()=>{t.invalidateQueries({queryKey:["interactions"]}),n("Interaktion uppdaterad!")},onError:()=>{n("Ett fel uppstod när interaktionen skulle uppdateras.","error")}})},mt=({onSubmit:t=()=>{},onChange:n,formProps:c,renderTopContent:u,renderBottomContent:l,...p})=>{const{data:k=[]}=tt(),{control:i,handleSubmit:a,watch:r,register:j,formState:{errors:g}}=B(c),b=r();return v.useEffect(()=>{n==null||n(b)},[n,b]),e.jsx(et,{...p,children:e.jsxs("form",{onSubmit:a(t),style:{...nt},children:[u==null?void 0:u(),e.jsxs(o,{container:!0,spacing:2,children:[e.jsx(o,{item:!0,xs:12,sm:6,children:e.jsxs(o,{container:!0,spacing:2,children:[e.jsx(o,{item:!0,xs:12,children:e.jsx(f,{fullWidth:!0,label:"Typ av interaktion",type:"text",margin:"none",...j("interactionType",{required:!0}),error:!!g.interactionType})}),e.jsx(o,{item:!0,xs:12,children:e.jsx(f,{multiline:!0,fullWidth:!0,minRows:4,label:"Noteringar",type:"text",margin:"none",...j("notes"),error:!!g.notes})})]})}),e.jsx(o,{item:!0,xs:12,sm:6,children:e.jsxs(o,{container:!0,spacing:2,children:[e.jsx(o,{item:!0,xs:12,children:e.jsx(F,{control:i,name:"interactionDate",rules:{required:!0},render:({field:d})=>e.jsx(P,{label:"Interaktionsdatum",value:R(d.value),inputRef:d.ref,onChange:s=>d.onChange(w(s))})})}),e.jsx(o,{item:!0,xs:12,children:e.jsx(F,{name:"contacts",control:i,render:({field:d})=>e.jsx(U,{multiple:!0,id:"multiple-contacts",options:k,getOptionKey:s=>s.contactId,getOptionLabel:s=>s.contactName,isOptionEqualToValue:(s,m)=>s.contactId===m.contactId,value:d.value,onChange:(s,m)=>d.onChange(m),renderInput:s=>e.jsx(f,{...s,label:"Kontakter",variant:"outlined",fullWidth:!0,error:!!g.contacts}),renderTags:(s,m)=>s.map((C,M)=>v.createElement(T,{...m({index:M}),key:C.contactId,label:C.contactName}))})})})]})})]}),l==null?void 0:l()]})})},Et=({interactions:t,isLoading:n,defaultValues:c})=>{const{mutate:u}=ct(),{mutate:l}=ut(),{mutate:p}=lt(),{mutate:k}=dt(),{mutate:i}=pt();return e.jsx(Y,{data:t,getRowId:a=>a.interactionId,state:{isLoading:n},columns:[{accessorKey:"interactionType",header:"Typ",filterVariant:"multi-select"},{accessorKey:"contacts",header:"Kontakter",minSize:150,enableEditing:!1,Cell:({cell:a})=>e.jsx(N,{disablePadding:!0,children:a.getValue().map(r=>e.jsx(O,{sx:{py:.5},disableGutters:!0,children:e.jsx(T,{component:V,variant:"outlined",avatar:e.jsx(W,{...G(r.contactName)}),label:r.contactName,to:`/home/contacts/${r.contactId}`,clickable:!0,size:"small"})},r.contactId))})},{accessorKey:"notes",header:"Noteringar"},{accessorFn:a=>R(a.interactionDate),header:"Interaktionsdatum",filterVariant:"date-range",enableEditing:!1,Cell:({cell:a})=>w(Z(a.getValue()))}],renderEditRowDialogContent:({row:a,table:r})=>e.jsxs(e.Fragment,{children:[e.jsx(z,{variant:"h4",color:"primary",children:r.getState().creatingRow?"Ny interaktion":"Redigera interaktion"}),e.jsx(H,{children:e.jsx(mt,{sx:{mt:1},formProps:{defaultValues:{...c,...a.original}},onChange:j=>{a._valuesCache=j}})}),e.jsx($,{children:e.jsx(J,{row:a,table:r,variant:"text"})})]}),onCreate:a=>[u(a,{onSuccess:({interactionId:r})=>{k({...a,interactionId:r})}})],onUpdate:a=>[l(a),i(a)],onDelete:a=>[p(a)]})},ft=t=>X({queryKey:["interactions",t],queryFn:()=>at(t),enabled:t&&Object.keys(t).length>0});export{Et as I,ft as u};
