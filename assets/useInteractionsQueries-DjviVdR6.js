import{q as C,m as N,v as O,n as V,o as w,p as P,s as h,r as b,j as t,G as o,t as g,h as K,C as M,b as W,d as G,L as U,A as z,w as H}from"./index-_FwCeTeu.js";import{t as v,p as I,u as j,c as k,d as B,A as $,D as S,a as T,b as F,M as q,e as J}from"./useSnackbar-_bOhQBdU.js";import{D as X}from"./DataTable-DldLoeRy.js";import{f as Q,t as Y}from"./date-BpXrROqC.js";import{u as Z,C as D}from"./index.esm-DWPQP-6d.js";import{u as tt}from"./useContactsQueries-Fpm1KDTO.js";import{F as et,s as nt}from"./FlexGrow-Bwm87unR.js";const at=async e=>{const i=(await C(`SELECT * FROM interactions
     WHERE interaction_id IN (
       SELECT interaction_id FROM interaction_contacts
       WHERE contact_id = :contactId)`,e)).map(c=>({...c,contacts:[]})),l=v(i,"interactionId"),m=await C("SELECT * FROM contacts"),p=v(m,"contactId");return(await C("SELECT * FROM interaction_contacts")).forEach(c=>{const n=l.get(c.interactionId),r=p.get(c.contactId);!n||!r||n.contacts.push(r)}),Array.from(l.values())},rt=async e=>await N("interactions",I({...e,interactionId:O()},["interactionId","interactionType","interactionDate","notes"])),st=async e=>await V("interactions",I(e,["interactionType","interactionDate","notes"]),I(e,["interactionId"])),ot=async e=>await w("interactions",I(e,["interactionId"])),_=async e=>await P("interaction_contacts",e.contacts.map(({contactId:a})=>({interactionId:e.interactionId,contactId:a}))),it=async e=>{await L(e),await _(e)},L=async e=>{await w("interaction_contacts",I(e,["interactionId","contactId"]))},ct=()=>{const e=h(),{showSnackbar:a}=j();return k({mutationFn:rt,onSuccess:()=>{e.invalidateQueries({queryKey:["interactions"]}),a("Interaktion sparat!")},onError:()=>{a("Ett fel uppstod när interaktionen skulle sparas.","error")}})},ut=()=>{const e=h(),{showSnackbar:a}=j();return k({mutationFn:st,onSuccess:()=>{e.invalidateQueries({queryKey:["interactions"]}),a("Interaktion uppdaterat!")},onError:()=>{a("Ett fel uppstod när interaktionen skulle uppdateras.","error")}})},lt=()=>{const e=h(),{showSnackbar:a}=j();return k({mutationFn:i=>Promise.all([ot(i),L(i)]),onSuccess:()=>{e.invalidateQueries({queryKey:["interactions"]}),a("Interaktion borttaget!")},onError:()=>{a("Ett fel uppstod när interaktionen skulle tas bort.","error")}})},dt=()=>{const e=h(),{showSnackbar:a}=j();return k({mutationFn:_,onSuccess:()=>{e.invalidateQueries({queryKey:["interactions"]}),a("Interaktion skapad!")},onError:()=>{a("Ett fel uppstod när interaktionen skulle skapas.","error")}})},mt=()=>{const e=h(),{showSnackbar:a}=j();return k({mutationFn:it,onSuccess:()=>{e.invalidateQueries({queryKey:["interactions"]}),a("Interaktion uppdaterad!")},onError:()=>{a("Ett fel uppstod när interaktionen skulle uppdateras.","error")}})},R=({onSubmit:e=()=>{},onChange:a,formProps:i,children:l,...m})=>{const{data:p=[]}=tt(),{control:x,handleSubmit:c,watch:n,register:r,formState:{errors:u}}=Z(i),f=n();return b.useEffect(()=>{a==null||a(f)},[a,f]),t.jsx(et,{...m,children:t.jsxs("form",{onSubmit:c(e),style:{...nt},children:[t.jsxs(o,{container:!0,spacing:2,children:[t.jsx(o,{item:!0,xs:12,sm:6,children:t.jsxs(o,{container:!0,spacing:2,children:[t.jsx(o,{item:!0,xs:12,children:t.jsx(g,{fullWidth:!0,label:"Typ av interaktion",type:"text",margin:"none",...r("interactionType",{required:!0}),error:!!u.interactionType})}),t.jsx(o,{item:!0,xs:12,children:t.jsx(g,{multiline:!0,fullWidth:!0,minRows:4,label:"Noteringar",type:"text",margin:"none",...r("notes"),error:!!u.notes})})]})}),t.jsx(o,{item:!0,xs:12,sm:6,children:t.jsxs(o,{container:!0,spacing:2,children:[t.jsx(o,{item:!0,xs:12,children:t.jsx(D,{control:x,name:"interactionDate",rules:{required:!0},render:({field:d})=>t.jsx(B,{label:"Interaktionsdatum",value:K(d.value),inputRef:d.ref,onChange:s=>d.onChange(Q(s))})})}),t.jsx(o,{item:!0,xs:12,children:t.jsx(D,{name:"contacts",control:x,render:({field:d})=>t.jsx($,{multiple:!0,id:"multiple-contacts",options:p,getOptionKey:s=>s.contactId,getOptionLabel:s=>s.contactName,isOptionEqualToValue:(s,y)=>s.contactId===y.contactId,value:d.value,onChange:(s,y)=>d.onChange(y),renderInput:s=>t.jsx(g,{...s,label:"Kontakter",variant:"outlined",fullWidth:!0,error:!!u.contacts}),renderTags:(s,y)=>s.map((E,A)=>b.createElement(M,{...y({index:A}),key:E.contactId,label:E.contactName}))})})})]})})]}),l]})})},Ct=({interactions:e,isLoading:a,defaultValues:i})=>{const{mutate:l}=ct(),{mutate:m}=ut(),{mutate:p}=lt(),{mutate:x}=dt(),{mutate:c}=mt();return t.jsx(X,{data:e,getRowId:n=>n.interactionId,state:{isLoading:a},columns:[{accessorKey:"interactionType",header:"Typ",filterVariant:"multi-select"},{accessorKey:"contacts",header:"Kontakter",minSize:150,enableEditing:!1,Cell:({cell:n})=>t.jsx(W,{disablePadding:!0,children:n.getValue().map(r=>t.jsx(G,{sx:{py:.5},disableGutters:!0,children:t.jsx(M,{component:U,variant:"outlined",avatar:t.jsx(z,{...H(r.contactName)}),label:r.contactName,to:`/dashboard/contacts/${r.contactId}`,clickable:!0,size:"small"})},r.contactId))})},{accessorKey:"notes",header:"Noteringar"},{accessorFn:n=>K(n.interactionDate),header:"Interaktionsdatum",filterVariant:"date-range",enableEditing:!1,Cell:({cell:n})=>Q(Y(n.getValue()))}],renderCreateRowDialogContent:({row:n,table:r})=>t.jsxs(t.Fragment,{children:[t.jsx(S,{variant:"h4",color:"primary",children:"Ny interaktion"}),t.jsx(T,{children:t.jsx(R,{sx:{mt:1},formProps:{defaultValues:i},onChange:u=>{n._valuesCache=u}})}),t.jsx(F,{children:t.jsx(q,{row:n,table:r,variant:"text"})})]}),renderEditRowDialogContent:({row:n,table:r})=>t.jsxs(t.Fragment,{children:[t.jsx(S,{variant:"h4",color:"primary",children:"Redigera interaktion"}),t.jsx(T,{children:t.jsx(R,{sx:{mt:1},formProps:{defaultValues:n.original},onChange:u=>{n._valuesCache=u}})}),t.jsx(F,{children:t.jsx(q,{row:n,table:r,variant:"text"})})]}),onCreate:n=>[l(n,{onSuccess:({interactionId:r})=>{x({...n,interactionId:r})}})],onUpdate:n=>[m(n),c(n)],onDelete:n=>[p(n)]})},gt=e=>J({queryKey:["interactions",e],queryFn:()=>at(e),enabled:e&&Object.keys(e).length>0});export{Ct as I,gt as u};
