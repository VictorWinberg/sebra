import{q as h,n as L,v as _,o as O,p as F,s as Q,t as g,r as w,j as e,G as i,w as j,h as R,C as T,b as A,d as N,L as V,A as W,x as G}from"./index-jNbj5-Yn.js";import{t as C,p as x,u as f,c as E,d as P,A as z,D as H,a as U,b as $,M as J,e as X}from"./useSnackbar-BCO__OmT.js";import{D as Y}from"./DataTable-mvu-ky1P.js";import{f as D,t as Z}from"./date-BpBCOTl2.js";import{u as B,C as S}from"./index.esm-P_7O7hqS.js";import{u as tt}from"./useContactsQueries-KoeaMlGs.js";import{F as et,s as at}from"./FlexGrow-DaKG00bv.js";const nt=async t=>{const d=(await h(`SELECT * FROM interactions
     WHERE interaction_id IN (
       SELECT interaction_id FROM interaction_contacts
       WHERE contact_id = :contactId)`,t)).map(r=>({...r,contacts:[]})),c=C(d,"interactionId"),o=await h("SELECT * FROM contacts"),m=C(o,"contactId");return(await h("SELECT * FROM interaction_contacts")).forEach(r=>{const u=c.get(r.interactionId),y=m.get(r.contactId);!u||!y||u.contacts.push(y)}),Array.from(c.values())},rt=async t=>{const a=await L("interactions",x({...t,interactionId:_()},["interactionId","interactionType","interactionDate","notes"]));await q({interactionId:a.interactionId,contacts:t.contacts})},st=async t=>{await O("interactions",x(t,["interactionType","interactionDate","notes"]),x(t,["interactionId"])),await ct(t)},it=async t=>{await M(t),await F("interactions",x(t,["interactionId"]))},q=async t=>{await Q("interaction_contacts",t.contacts.map(({contactId:a})=>({interactionId:t.interactionId,contactId:a})))},ct=async t=>{await M(t),await q(t)},M=async t=>{await F("interaction_contacts",x(t,["interactionId"]))},ot=()=>{const t=g(),{showSnackbar:a}=f();return E({mutationFn:rt,onSuccess:()=>{t.invalidateQueries({queryKey:["interactions"]}),a("Interaktion sparat!")},onError:()=>{a("Ett fel uppstod när interaktionen skulle sparas.","error")}})},ut=()=>{const t=g(),{showSnackbar:a}=f();return E({mutationFn:st,onSuccess:()=>{t.invalidateQueries({queryKey:["interactions"]}),a("Interaktion uppdaterat!")},onError:()=>{a("Ett fel uppstod när interaktionen skulle uppdateras.","error")}})},lt=()=>{const t=g(),{showSnackbar:a}=f();return E({mutationFn:it,onSuccess:()=>{t.invalidateQueries({queryKey:["interactions"]}),a("Interaktion borttaget!")},onError:()=>{a("Ett fel uppstod när interaktionen skulle tas bort.","error")}})},dt=({onSubmit:t=()=>{},onChange:a,formProps:d,renderTopContent:c,renderBottomContent:o,...m})=>{const{data:n=[]}=tt(),{control:r,handleSubmit:u,watch:y,register:b,formState:{errors:I}}=B(d),k=y();return w.useEffect(()=>{a==null||a(k)},[a,k]),e.jsx(et,{...m,children:e.jsxs("form",{onSubmit:u(t),style:{...at},children:[c==null?void 0:c(),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:12,children:e.jsx(j,{fullWidth:!0,label:"Typ av interaktion",type:"text",margin:"none",...b("interactionType",{required:!0}),error:!!I.interactionType})}),e.jsx(i,{item:!0,xs:12,children:e.jsx(j,{multiline:!0,fullWidth:!0,minRows:4,label:"Noteringar",type:"text",margin:"none",...b("notes"),error:!!I.notes})})]})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:12,children:e.jsx(S,{control:r,name:"interactionDate",rules:{required:!0},render:({field:l})=>e.jsx(P,{label:"Interaktionsdatum",value:R(l.value),inputRef:l.ref,onChange:s=>l.onChange(D(s))})})}),e.jsx(i,{item:!0,xs:12,children:e.jsx(S,{name:"contacts",control:r,render:({field:l})=>e.jsx(z,{multiple:!0,disableCloseOnSelect:!0,id:"multiple-contacts",options:n,getOptionKey:s=>s.contactId,getOptionLabel:s=>s.contactName,isOptionEqualToValue:(s,p)=>s.contactId===p.contactId,value:l.value,onChange:(s,p)=>l.onChange(p),renderInput:s=>e.jsx(j,{...s,label:"Kontakter",variant:"outlined",fullWidth:!0,error:!!I.contacts}),renderTags:(s,p)=>s.map((v,K)=>w.createElement(T,{...p({index:K}),key:v.contactId,label:v.contactName}))})})})]})})]}),o==null?void 0:o()]})})},gt=({interactions:t,isLoading:a,defaultValues:d})=>{const{mutate:c}=ot(),{mutate:o}=ut(),{mutate:m}=lt();return e.jsx(Y,{data:t,getRowId:n=>n.interactionId,state:{isLoading:a},columns:[{accessorKey:"interactionType",header:"Typ",filterVariant:"multi-select"},{accessorKey:"contacts",header:"Kontakter",minSize:150,enableEditing:!1,Cell:({cell:n})=>e.jsx(A,{disablePadding:!0,children:n.getValue().map(r=>e.jsx(N,{sx:{py:.25},disableGutters:!0,children:e.jsx(T,{component:V,variant:"outlined",avatar:e.jsx(W,{...G(r.contactName)}),label:r.contactName,to:`/home/contacts/${r.contactId}`,clickable:!0,size:"small"})},r.contactId))})},{accessorKey:"notes",header:"Noteringar"},{accessorFn:n=>R(n.interactionDate),header:"Interaktionsdatum",filterVariant:"date-range",enableEditing:!1,Cell:({cell:n})=>D(Z(n.getValue()))}],renderEditRowDialogContent:({row:n,table:r})=>e.jsxs(e.Fragment,{children:[e.jsx(H,{variant:"h4",color:"primary",children:r.getState().creatingRow?"Ny interaktion":"Redigera interaktion"}),e.jsx(U,{children:e.jsx(dt,{sx:{mt:1},formProps:{defaultValues:{...d,...n.original}},onChange:u=>{n._valuesCache=u}})}),e.jsx($,{children:e.jsx(J,{row:n,table:r,variant:"text"})})]}),onCreate:n=>c(n),onUpdate:n=>o(n),onDelete:n=>m(n)})},ft=t=>X({queryKey:["interactions",t],queryFn:()=>nt(t),enabled:t&&Object.keys(t).length>0});export{gt as I,ft as u};
